# vue3.2æ ¸å¿ƒ

## *æœ€ä½³ç»„ä»¶é€»è¾‘å¤ç”¨æ–¹å¼ï¼š`Composables`

å…¶å®ï¼šåƒä¸‹é¢çš„`ref`å‘€ã€`watch`å‘€éƒ½æ˜¯`composables`ã€‚

æ— æ•Œå•Šè¿™ä¸ªï¼šç›´æ¥èƒ½æŠŠé€»è¾‘æŠ½ç¦»å‡ºæ¥ï¼Œæ— æ•Œäº†ã€‚

æ›¿ä»£`vue2`ä¸­çš„`Mixin`ä½†æ˜¯æ¯”`Mixin`å¼ºå¤šäº†

* `composable`æ˜¯ä¸€ä¸ªæ™®é€šçš„jså‡½æ•°
* setup()ä¸­çš„ä»£ç å…¨éƒ¨éƒ½å¯ä»¥åœ¨`composables`ä¸­ç¼–å†™
* `composables`**é€»è¾‘è¶Šç‹¬ç«‹è¶Šå¥½**
* èƒ½å‡å°‘ç»„ä»¶æ–‡ä»¶çš„ä»£ç ï¼Œå¢å¼ºå¤ç”¨æ€§

>ç¬¬ä¸€æ­¥ï¼šåœ¨srcä¸‹åˆ›å»º`composables`æ–‡ä»¶å¤¹

>ç¬¬äºŒæ­¥ï¼šæ–°å»ºä¸€ä¸ªuseListData.jsæ–‡ä»¶
>
>æ³¨æ„ï¼š`composables`æ–‡ä»¶å»ºè®®ä»¥useå¼€å¤´



>ç¬¬ä¸‰æ­¥ï¼šä¹¦å†™å…¬ç”¨ä»£ç 

`useListData.js`ï¼šåˆ›å»ºdataï¼Œå¹¶æœ‰ä¸€ä¸ªåˆ é™¤å‡½æ•°

```js
import { ref } from 'vue';

function useListData(data) {
	const dataRef = ref(data);

	function removeItem(id) {
		dataRef.value = dataRef.value.filter(data => {
			return data.id !== id;
		});
	}

	return { data: dataRef, removeItem };
}

export default useListData;

```



>ç¬¬å››æ­¥ï¼šä½¿ç”¨

`MessageList.vue`ç»„ä»¶ï¼š

```vue
<template>
	<ul>
		<li v-for="item in messagesList" :key="item.id">
			{{ item.name }}
			<button @click="removeMessageItem(item.id)">Remove</button>
		</li>
	</ul>
</template>
<script>
import useListData from '../composables/useListData';
export default {
	setup() {
    // è¿™é‡Œè°ƒç”¨composableså¹¶ç»“æ„å‡ºæ¥
		const { data: messagesList, removeItem: removeMessageItem } = useListData([
			{
				id: 1,
				name: 'é’±ä¸äºŒ'
			},
			{
				id: 2,
				name: 'é’±æŸäºº'
			}
		]);
		console.log(messagesList.value);
		return { messagesList, removeMessageItem };
	}
};
</script>

```





## setupçš„è¯­æ³•ç³–

è¯¥è¯­æ³•ç³–ï¼šåœ¨vue3.2ä¸­æ‰èƒ½ä½¿ç”¨

![08-setupè¯­æ³•ç³–](../../å‰ç«¯å›¾ç‰‡/vue3.2/08-setupè¯­æ³•ç³–.PNG)

1ï¼‰ä¸‹é¢çš„`API`(æˆ–è€…å«`composables`)ä¾‹å¦‚`ref`ã€`reactive`ã€`watch`ã€`computed`ç­‰è¿˜æœ‰ç”Ÿå‘½å‘¨æœŸé’©å­ç›´æ¥å†™ã€‚



2ï¼‰å¹¶ä¸”æ¨¡æ¿ä¸­èƒ½ç›´æ¥ä½¿ç”¨<script setup>ä¸­å®šä¹‰çš„å˜é‡ä¸å‡½æ•°å¦‚ä¸‹å›¾ï¼š

<img src="../../å‰ç«¯å›¾ç‰‡/vue3.2/09-setupè¯­æ³•ç³–2.PNG" alt="09-setupè¯­æ³•ç³–2" style="zoom:150%;" />



3ï¼‰ç”±äºæ— æ³•ä½¿ç”¨componentsé…ç½®é¡¹ï¼Œå¼•å…¥çš„ç»„ä»¶å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ— æ•ŒğŸ‘

![08-setupè¯­æ³•ç³–3](../../å‰ç«¯å›¾ç‰‡/vue3.2/08-setupè¯­æ³•ç³–3.PNG)



### `<script setup>`å®šä¹‰props

æ³¨æ„ï¼šé»˜è®¤å°±æœ‰`defineProps`ï¼Œä¸éœ€è¦æˆ‘ä»¬`import`

ç”±äºè¯­æ³•ç³–å†™æ³•ï¼Œå°±ä¸èƒ½å†™`props`é…ç½®é¡¹äº†ï¼Œé€šè¿‡`defineProps`æ¥è·å–ï¼Œå®ƒæ¥æ”¶å’Œ`props`é…ç½®é¡¹ä¸€æ ·çš„å‚æ•°

ç¤ºä¾‹ï¼š

```vue
<template>
	<!--æ¨¡æ¿ä¸­çš„ä½¿ç”¨æ–¹å¼ä¸å˜-->
	<p>
    {{title}}
  </p>
</template>
<script setup>
  const props = defineProps(['title', 'name'])
  
  
  // åœ¨setupä¸­è®¿é—®propsï¼Œå¯ä»¥æ¥æ”¶definePropsçš„å€¼
  console.log(props.title);
</script>




<script>
// å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨ <script setup>ï¼Œ1.å¿…é¡»è¦ä»¥ğŸ‘‡æ–¹å¼å£°æ˜ä¸€ä¸‹(å’Œvue2ä¸€è‡´)2.éœ€è¦é€šè¿‡setupç¬¬ä¸€ä¸ªå‚æ•°æ¥è®¿é—®props
export default {
  props: ['title'],
  setup(props) {
    console.log(props.title)
  }
}
</script>
```





### `<script setup>`å®šä¹‰emits

æ³¨æ„ï¼šé»˜è®¤å°±æœ‰`defineEmits`ï¼Œä¸éœ€è¦æˆ‘ä»¬`import`

ç”±äºè¯­æ³•ç³–å†™æ³•ä¹Ÿä¸èƒ½ä½¿ç”¨emitsé…ç½®é¡¹ï¼Œé€šè¿‡`defineEmits`apiæ¥æ¥æ”¶`emits`ã€‚

>æ³¨æ„ï¼š`defineEmits()` å®**ä¸èƒ½**åœ¨å­å‡½æ•°ä¸­ä½¿ç”¨ã€‚å¦‚ä¸Šæ‰€ç¤ºï¼Œå®ƒå¿…é¡»ç›´æ¥æ”¾ç½®åœ¨ `<script setup>` çš„é¡¶çº§ä½œç”¨åŸŸä¸‹ã€‚

ç¤ºä¾‹ï¼š

```vue
<template>
	<!--æ¨¡æ¿ä¸­è§¦å‘ä¸å˜-->
	<button @click="$emit('remove')">
    ç‚¹æˆ‘
  </button>
</template>
<script setup>
  const emit = defineEmits(['click', 'remove']);
  
  // setupä¸­ä½¿ç”¨,é€šè¿‡defineEmitsçš„è¿”å›å€¼
  function handleClick() {
    emit('click')
  }
</script>


<script>
// å¦‚æœæ²¡æœ‰ä½¿ç”¨setupè¯­æ³•ç³–ï¼Œ1.éœ€è¦å£°æ˜emits 2.éœ€è¦åœ¨setupå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ¥è®¿é—®emit
export default {
  emits: ['enlarge-text'],
  setup(props, ctx) {
    ctx.emit('enlarge-text')
  }
}
</script>
```



**äº‹ä»¶æ ¡éªŒ**ï¼š

å’Œå¯¹ props æ·»åŠ ç±»å‹æ ¡éªŒçš„æ–¹å¼ç±»ä¼¼ï¼Œæ‰€æœ‰è§¦å‘çš„äº‹ä»¶ä¹Ÿå¯ä»¥ä½¿ç”¨å¯¹è±¡å½¢å¼æ¥æè¿°ã€‚

è¦ä¸ºäº‹ä»¶æ·»åŠ æ ¡éªŒï¼Œé‚£ä¹ˆäº‹ä»¶å¯ä»¥è¢«èµ‹å€¼ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—çš„å‚æ•°å°±æ˜¯æŠ›å‡ºäº‹ä»¶æ—¶ä¼ å…¥ `emit` çš„å†…å®¹ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼æ¥è¡¨æ˜äº‹ä»¶æ˜¯å¦åˆæ³•ã€‚

ç¤ºä¾‹ï¼š

```vue
<script setup>
const emit = defineEmits({
  // æ²¡æœ‰æ ¡éªŒ
  click: null,

  // æ ¡éªŒ submit äº‹ä»¶
  submit: ({ email, password }) => {
    if (email && password) {
      return true
    } else {
      console.warn('Invalid submit event payload!')
      return false
    }
  }
})

function submitForm(email, password) {
  emit('submit', { email, password })
}
</script>
```





### `<script setup>`ä¸­çš„slotså’Œattrs

å¯¹äºsetup(props,  context)å‡½æ•°ä¸­çš„`context.slots`å’Œ`context.attrs`æœ‰ä»¥ä¸‹ä¿©apiï¼š

![08-setupè¯­æ³•ç³–4](../../å‰ç«¯å›¾ç‰‡/vue3.2/08-setupè¯­æ³•ç³–4.PNG)



### æ³¨å†Œç»„ä»¶

åœ¨`<script setup>`ä¸­ï¼Œimportè¿›æ¥çš„ç»„ä»¶ï¼Œç›´æ¥å¯ä»¥åœ¨templateä¸­ä½¿ç”¨ï¼Œè€Œä¸æ˜¯åƒ`vue2`ä¸­ä¸€æ ·éœ€è¦componentsæ³¨å†Œä¸€ä¸‹

ç¤ºä¾‹ï¼š

```vue
<script setup>
import ComponentA from './ComponentA.vue'
</script>

<template>
  <ComponentA />
</template>
```







# å„ç§`composables`

## setup()

setupå‡½æ•°ä½œä¸ºå¼€å§‹çš„èµ·ç‚¹ã€‚

è¯­æ³•ï¼š

```vue
<template>
	...
</template>
<script>
  // æ³¨æ„setupä¸­è¿”å›çš„ç»“æœï¼Œå¯ä»¥ç›´æ¥åœ¨templateä¸­ä½¿ç”¨
	setup() {
    return {
      xxx
    }
  }
</script>
```



## toRefs()å‡½æ•°

toRefså‡½æ•°çš„ä½œç”¨ï¼Œæ˜¯å°†ä¸€ä¸ªéå“åº”å¼çš„å¯¹è±¡è½¬æ¢æˆä¸€ä¸ªå“åº”å¼çš„å¯¹è±¡ã€‚

ç¤ºä¾‹ï¼š

```vue
<script>
	setup(props) {
    // å°†propså¯¹è±¡ï¼ŒåŒ…è£…ä¸ºå“åº”å¼å¯¹è±¡
    const {title} = toRefs(props);
  }
</script>
```

### toRef()å‡½æ•°

toRef()å‡½æ•°èƒ½å¤Ÿå°†ä¸€ä¸ªå¯¹è±¡ä¸­çš„æŸä¸ªå€¼è½¬æ¢æˆå“åº”å¼æ•°æ®

è¯­æ³•ï¼š

```js
toRef(å¯¹è±¡, å±æ€§å)
```





ç¤ºä¾‹ï¼š

```vue
<script>
	setup(props) {
    // å°†propsä¸‹çš„titleå±æ€§åŒ…è£…æˆå“åº”å¼çš„
    const title = toRef(props, 'title');
  }
</script>
```



## ref()å‡½æ•°

ref(å‚æ•°)å‡½æ•°æ¥æ”¶ä¸€ä¸ªä»»æ„ç±»å‹çš„å‚æ•°ï¼Œä¼šå°†å‚æ•°åŒ…è£…æˆå“åº”å¼æ•°æ®ç„¶åè¿”å›ã€‚

ä½œç”¨ï¼šç”¨æ¥æ›¿ä»£`data`é…ç½®é¡¹

>ä¸€èˆ¬æ¥è¯´å®ƒæ˜¯ç”¨äºä»£æ›¿dataé…ç½®é¡¹ä¸­çš„åŸºç¡€ç±»å‹æ•°æ®ï¼ˆbutå®ƒä¹Ÿå¯ä»¥å¤„ç†å¼•ç”¨ç±»å‹çš„æ•°æ®ï¼‰

è¯­æ³•ï¼š

```vue
<template>
	<p>
    <!--æ³¨æ„ï¼šæ¨¡æ¿ä¸­ä¸éœ€è¦.valueæ¥è®¿é—®-->
    {{num}}
  </p>
</template>
<script>
	import {ref} from 'vue';
  setup() {
    let str = 'å­—ç¬¦ä¸²';
		const num = ref(0);
    const s= ref( str);
    
    // è®¿é—®æ•°æ®
    num.value
    
    // æ³¨æ„å“åº”å¼æ•°æ®å’ŒåŸå§‹æ•°æ®ä¸ç›¸ç­‰
    str === s.value; // false
    
    return {num}
  }
</script>
```

æ³¨æ„ç‚¹ï¼š

1. åœ¨setupä¸­refåŒ…è£¹çš„å˜é‡éƒ½éœ€è¦é€šè¿‡`.value`æ¥è®¿é—®
2. åœ¨æ¨¡æ¿`template`ä¸­ä¼šè¢«è‡ªåŠ¨â€è§£åŒ…â€œï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œè®¿é—®è€Œä¸éœ€è¦`.value`
3. è·Ÿå“åº”å¼å¯¹è±¡ä¸åŒï¼Œå½“ ref ä½œä¸º**å“åº”å¼æ•°ç»„æˆ–åƒ `Map` è¿™ç§åŸç”Ÿé›†åˆç±»å‹çš„å…ƒç´ è¢«è®¿é—®æ—¶ï¼Œä¸ä¼šè¿›è¡Œè§£åŒ…**ã€‚
4. refè§£åŒ…ï¼Œåªä¼šä½œç”¨äºé¡¶å±‚å±æ€§

è§£åŒ…é—®é¢˜ç¤ºä¾‹ï¼š

```js
const object = { foo: ref(1) }
```

ä¸‹é¢çš„è¡¨è¾¾å¼å°†ä¸ä¼šåƒé¢„æœŸä¸€æ ·æ‰§è¡Œï¼š

```js
{{ object.foo + 1 }}
```

è§£å†³åŠæ³•ï¼šç›´æ¥è¿›è¡Œç»“æ„ï¼Œå°†refåŒ…è£¹çš„å“åº”å¼æ•°æ®ç½®äºé¡¶å±‚

```js
const { foo } = object;
{{ foo + 1 }} // å¯ä»¥åƒé¢„æœŸä¸€æ ·å·¥ä½œ
```





## reactive()å‡½æ•°

reactiveå‡½æ•°å’Œrefå‡½æ•°ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒåªæ¥å—ä¸€ä¸ªå¯¹è±¡ç±»å‹çš„æ•°ç»„ï¼Œä¹Ÿæ˜¯å°†å‚æ•°åŒ…è£…æˆå“åº”å¼ç„¶åè¿›è¡Œè¿”å›ã€‚

ä½œç”¨ï¼šä¹Ÿæ˜¯ç”¨æ¥æ›¿ä»£`data`é…ç½®é¡¹çš„

>æ³¨æ„ï¼Œreactiveå‡½æ•°æ˜¯ç”¨æ¥æ›¿ä»£dataé…ç½®é¡¹ä¸­çš„**å¼•ç”¨æ•°æ®ç±»å‹çš„**

>tipsï¼šå’Œrefç›¸æ¯”ï¼Œreactiveé€‚åˆåœ¨ä¸€æ¬¡æ€§å®šä¹‰å¤§é‡æ•°æ®çš„åœ°æ–¹ä½¿ç”¨ï¼Œä¾‹å¦‚è¡¨å•æ•°æ®ã€‚**è€Œä¸”reactiveå®šä¹‰çš„æ•°æ®ä¸éœ€è¦`.value`æ¥è®¿é—®**ï¼ˆå½“ç„¶æˆ‘ä»¬å¯ä»¥ç›´æ¥refä¸€æŠŠæ¢­ä¸€ğŸ¤£ï¼‰

è¯­æ³•ï¼š

```vue
<template>
	<p>
    {{obj.a}}
  </p>
</template>

<script>
import {reactive} from 'vue';
setup() {
  const obj = reactive({a: 1, b: 2});
  const arr = reactive([1, 2, 3, 4]);
  
  
  return {obj}
}
</script>
```



æ³¨æ„ï¼šï¼ˆæ¥è‡ªå®˜ç½‘ï¼‰

1. ä»…å¯¹å¯¹è±¡ç±»å‹æœ‰æ•ˆï¼ˆå¯¹è±¡ã€æ•°ç»„å’Œ `Map`ã€`Set` è¿™æ ·çš„[é›†åˆç±»å‹](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects#ä½¿ç”¨é”®çš„é›†åˆå¯¹è±¡)ï¼‰ï¼Œè€Œå¯¹ `string`ã€`number` å’Œ `boolean` è¿™æ ·çš„ [åŸå§‹ç±»å‹](https://developer.mozilla.org/zh-CN/docs/Glossary/Primitive) æ— æ•ˆã€‚

2. å› ä¸º Vue çš„å“åº”å¼ç³»ç»Ÿæ˜¯é€šè¿‡å±æ€§è®¿é—®è¿›è¡Œè¿½è¸ªçš„ï¼Œ**å› æ­¤æˆ‘ä»¬å¿…é¡»å§‹ç»ˆä¿æŒå¯¹è¯¥å“åº”å¼å¯¹è±¡çš„ç›¸åŒå¼•ç”¨**ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä¸å¯ä»¥éšæ„åœ°â€œæ›¿æ¢â€ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œå› ä¸ºè¿™å°†å¯¼è‡´å¯¹åˆå§‹å¼•ç”¨çš„å“åº”æ€§è¿æ¥ä¸¢å¤±ï¼š

   ```js
   let state = reactive({ count: 0 })
   
   // ä¸Šé¢çš„å¼•ç”¨ ({ count: 0 }) å°†ä¸å†è¢«è¿½è¸ªï¼ˆå“åº”æ€§è¿æ¥å·²ä¸¢å¤±ï¼ï¼‰
   state = reactive({ count: 1 })
   
   // å¦‚æœå°†å“åº”å¼å¯¹è±¡ä¸­çš„åŸºç¡€ç±»å‹æ•°æ®ç»“æ„å‡ºæ¥ï¼Œåˆ™ä¼šå¯¼è‡´countä¸¢å¤±å“åº”æ€§
   let { count } = state;
   count += 1; // ä¸ä¼šå½±å“åˆ°state.countçš„å€¼
   
   state2 = reactive({count: {a:1}});
   // å¦‚æœç»“æ„çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™ä¸ä¼šæœ‰é—®é¢˜
   let {count} = state2;
   ```

   





## computed()å‡½æ•°

ä½œç”¨ï¼šcomputedå‡½æ•°ç”¨æ¥å®šä¹‰è®¡ç®—å±æ€§ï¼Œå®ƒå°±æ˜¯ç”¨æ¥æ›¿ä»£`computed`é…ç½®é¡¹çš„ã€‚

>computedå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªrefå¯¹è±¡ï¼Œæ‰€ä»¥computed()è¿”å›å¯¹è±¡çš„ä½¿ç”¨å’Œæ³¨æ„ç‚¹éƒ½æ˜¯å’Œrefä¸€è‡´çš„

è¯­æ³•ï¼š

```vue
<template>


</template>
<script>
	import {computed} from 'vue';
  setup() {
    // computedå‡½æ•°æ¥æ”¶ä¸€ä¸ªæ²¡æœ‰å‚æ•°çš„å›è°ƒ
    const search = computed(() => {
      return .....;
    })
    
    // è®¿é—®ä¹Ÿéœ€è¦.value
    console.log(search.value);
    
    return {search}
  }
</script>
```

æ³¨æ„ï¼š

1. **computedå’Œrefå®šä¹‰å‡ºçš„æ•°æ®ï¼Œåœ¨è®¿é—®æ–¹å¼ä¸Šæ˜¯ä¸€æ ·çš„ã€‚**

2. **computedä¸€å®šè¦ä¾èµ–ä¸€ä¸ªå“åº”å¼æ•°æ®ï¼Œå¦åˆ™ä¼šå¯¼è‡´computedæ°¸è¿œä¸æ›´æ–°çš„é—®é¢˜**

   ç¤ºä¾‹ï¼š

   ```js
   const now = computed(() => Date.now())
   // è¿™ä¸ªnowå°±æ°¸è¿œä¸ä¼šæ”¹å˜ï¼Œåº”ä¸ºDate.now()ä¸æ˜¯ä¸€ä¸ªå“åº”å¼æ•°æ®
   ```



**å¯å†™è®¡ç®—å±æ€§**

è®¡ç®—å±æ€§é»˜è®¤æ˜¯åªè¯»çš„ã€‚å½“ä½ å°è¯•ä¿®æ”¹ä¸€ä¸ªè®¡ç®—å±æ€§æ—¶ï¼Œä½ ä¼šæ”¶åˆ°ä¸€ä¸ªè¿è¡Œæ—¶è­¦å‘Šã€‚åªåœ¨æŸäº›ç‰¹æ®Šåœºæ™¯ä¸­ä½ å¯èƒ½æ‰éœ€è¦ç”¨åˆ°â€œå¯å†™â€çš„å±æ€§ï¼Œä½ å¯ä»¥é€šè¿‡åŒæ—¶æä¾› getter å’Œ setter æ¥åˆ›å»ºï¼š

**æ³¨æ„ï¼Œå¯å†™çš„è®¡ç®—å±æ€§æˆ‘è§‰å¾—æ˜¯ä¸å»ºè®®ä½¿ç”¨çš„ï¼Œç©¶å…¶æ ¹æœ¬å…¶å®æ˜¯è®¡ç®—å±æ€§æœ€å¥½åªæ˜¯æºæ•°æ®çš„å¿«ç…§ï¼Œæœ€å¥½ä¸è¦å‡ºç°å‰¯ä½œç”¨ï¼ˆæœ‰å‰¯ä½œç”¨çš„æˆ‘ä»¬å¯ä»¥ç”¨watchï¼‰**

```vue
<script setup>
import { ref, computed } from 'vue'

const firstName = ref('John')
const lastName = ref('Doe')

const fullName = computed({
  // getter
  get() {
    return firstName.value + ' ' + lastName.value
  },
  // setter
  set(newValue) {
    // æ³¨æ„ï¼šæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯è§£æ„èµ‹å€¼è¯­æ³•
    [firstName.value, lastName.value] = newValue.split(' ')
  }
})
</script>
```









## watch()å‡½æ•°

ä½œç”¨ï¼šwatchå‡½æ•°ç”¨æ¥æ›¿ä»£vue2ä¸­çš„`watch`é…ç½®é¡¹

watchå‡½æ•°çš„ä½¿ç”¨æœ‰å¾ˆå¤šæ³¨æ„é¡¹ï¼Œæˆ‘ä»¬ä¸€ç‚¹ä¸€ç‚¹æ¥çœ‹ã€‚

### ç¬¬ä¸€ç§ï¼šç›‘å¬æ™®é€šæ•°æ®ç±»å‹çš„`ref`

```vue
<script>
  import {watch} from 'vue';
	setup() {
    const searchTerm = ref("");
    
    // 1.ç›´æ¥ç›‘å¬ refè¿”å›çš„å€¼1
    watch(searchTerm, (newVal, oldVal) => {
      console.log('æ–°å€¼', newVal);
      console.log('æ—§å€¼', oldVal);
    })
    // è¿™ä¸¤ç§å†™æ³•åŠŸèƒ½ä¸€æ ·
    
    //2.ç›‘å¬.value éœ€è¦å†™æˆä¸€ä¸ªå›è°ƒæ–¹å¼ 
    watch(()=>searchTerm.value, (newVal, oldVal) => {
      console.log('æ–°å€¼', newVal);
      console.log('æ—§å€¼', oldVal);
    })
  }
</script>
```



### ç¬¬äºŒç§ï¼šç›‘å¬å¯¹è±¡ç±»å‹ä¸­çš„åŸºæœ¬ç±»å‹çš„`ref`

watch()å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦å†™æˆå›è°ƒå‡½æ•°å†™æ³•ã€‚

ç¤ºä¾‹ï¼š

```vue
<script>
  import {watch} from 'vue';
	setup() {
    const searchTerm = ref(
      {
        id: 1,
        name: 'é’±ä¸äºŒ'
      }
    );
    
    
    //ç›‘å¬å¯¹è±¡å±æ€§ï¼Œéœ€è¦å†™æˆä¸€ä¸ªå›è°ƒæ–¹å¼ 
    watch(()=>searchTerm.value.name, (newVal, oldVal) => {
      console.log('æ–°å€¼', newVal);
      console.log('æ—§å€¼', oldVal);
    })
  }
</script>
```



### ç¬¬ä¸‰ç§ï¼šç›´æ¥ç›‘å¬æ•´ä¸ªå¯¹è±¡çš„ref

watch()å‡½æ•°ï¼Œéœ€è¦ä¼ é€’ç¬¬ä¸‰ä¸ªå‚æ•°ä½œä¸ºé…ç½®é¡¹ï¼Œå¼€å¯æ·±åº¦ç›‘è§†

ç¤ºä¾‹ï¼š

```vue
<script>
  import {watch} from 'vue';
	setup() {
    const searchTerm = ref(
      {
        id: 1,
        name: 'é’±ä¸äºŒ'
      }
    );
    
    
    //1.åªå•çº¯ç›‘å¬æ•´ä¸ªå¯¹è±¡ï¼Œå¯¹è¿”å›å€¼æ²¡æœ‰è¦æ±‚çš„æƒ…å†µ
    watch(()=>searchTerm.value, (newVal, oldVal) => {			
      // æ³¨æ„è¿™é‡Œä¸¤ä¸ªå€¼æ˜¯ä¸€æ ·çš„ï¼Œè™½ç„¶ç›‘å¬åˆ°äº†ä¿®æ”¹ï¼Œä½†æ˜¯å¯¹è±¡çš„å¼•ç”¨åœ°å€å€¼æ²¡æ”¹å˜ï¼ŒnewVal === oldVal 
      console.log('æ–°å€¼', newVal);
      console.log('æ—§å€¼', oldVal);
    },
    {
      deep: true
    })
    
    
    // 2.å¦‚æœæƒ³è¦è·å–newValå’ŒoldValçš„æ”¹å˜ï¼Œéœ€è¦å°†ç¬¬ä¸€ä¸ªå‚æ•°è¿”å›çš„å¯¹è±¡è¿›è¡Œæ·±å…‹éš†ï¼Œæ·±å…‹éš†å¯ä»¥ä½¿ç”¨lodashåº“æˆ–è€…è‡ªå·±å°è£…
    watch(()=>JSON.parse(JSON.strigfy(searchTerm.value)), (newVal, oldVal) => {			
      // æ­¤æ—¶ï¼ŒnewValå’ŒoldValå°±æ˜¯ä¸¤ä¸ªä¸åŒçš„å€¼
      console.log('æ–°å€¼', newVal);
      console.log('æ—§å€¼', oldVal);
    },
    {
      deep: true
    })
  }
</script>
```

æ³¨æ„:**ä¸Šé¢æ–¹æ³•2ï¼šwatch()å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ˜¯ä¸€ä¸ªå›è°ƒï¼Œå›è°ƒçš„è¿”å›å€¼ï¼Œå¿…é¡»æ˜¯æ·±å…‹éš†çš„ä¸€ä¸ªå¯¹è±¡ã€‚**



### ç¬¬å››ç§ï¼šåŒæ—¶ç›‘å¬å¤šä¸ªæ•°å€¼

å¯ä»¥å°†ç¬¬ä¸€ä¸ªå‚æ•°å†™æˆä¸€ä¸ªæ•°ç»„çš„å½¢å¼ã€‚

ç¤ºä¾‹ï¼š

```vue
<script>
  import {watch} from 'vue';
	setup() {
    const searchTerm = ref(
      {
        id: 1,
        name: 'é’±ä¸äºŒ'
      }
    );
    
    
    //ç¬¬ä¸€ä¸ªå‚æ•°å†™æˆä¸€ä¸ªæ•°ç»„å½¢å¼
    watch([
      ()=>searchTerm.value.name,
      ()=>searchTerm.value.id
    ], (newVal, oldVal) => {
      console.log('æ–°å€¼', newVal);
      console.log('æ—§å€¼', oldVal);
    })
  }
</script>
```





### watchçš„é…ç½®é¡¹

åœ¨`watch(source, callback, options)`å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œæœ€åä¸€ä¸ªoptionså‚æ•°å¯ä»¥å¯¹watchçš„ä¸€äº›è¡Œä¸ºè¿›è¡Œé…ç½®

watchçš„optionså¸¸ç”¨çš„æœ‰ä¸‰ä¸ªï¼š`immediate`ã€`deep`ã€`flush`

æ¥ä¸‹æ¥ä¸€ä¸€è¿›è¡Œä»‹ç»ï¼š

ä¸€ï¼š`immediate`

ä½œç”¨ï¼šç«‹å³è®©watchè¿›è¡Œç›‘å¬

åŸå› ï¼š**`watch` é»˜è®¤æ˜¯æ‡’æ‰§è¡Œçš„**ï¼šä»…å½“æ•°æ®æºå˜åŒ–æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œå›è°ƒã€‚ä½†åœ¨æŸäº›åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨åˆ›å»ºä¾¦å¬å™¨æ—¶ï¼Œç«‹å³æ‰§è¡Œä¸€éå›è°ƒã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬æƒ³è¯·æ±‚ä¸€äº›åˆå§‹æ•°æ®ï¼Œç„¶ååœ¨ç›¸å…³çŠ¶æ€æ›´æ”¹æ—¶é‡æ–°è¯·æ±‚æ•°æ®ã€‚

ç¤ºä¾‹ï¼š

```js
watch(source, (newValue, oldValue) => {
  // ç«‹å³æ‰§è¡Œï¼Œä¸”å½“ `source` æ”¹å˜æ—¶å†æ¬¡æ‰§è¡Œ
}, { immediate: true })
```



äºŒï¼š`deep`

ä½œç”¨ï¼šå¼€å¯æ·±åº¦ç›‘å¬

```js
watch(source, (newValue, oldValue) => {
  
}, { deep: true })
```

>æ³¨æ„ï¼šæ·±åº¦ä¾¦å¬éœ€è¦éå†è¢«ä¾¦å¬å¯¹è±¡ä¸­çš„æ‰€æœ‰åµŒå¥—çš„å±æ€§ï¼Œå½“ç”¨äºå¤§å‹æ•°æ®ç»“æ„æ—¶ï¼Œå¼€é”€å¾ˆå¤§ã€‚å› æ­¤è¯·åªåœ¨å¿…è¦æ—¶æ‰ä½¿ç”¨å®ƒï¼Œå¹¶ä¸”è¦ç•™æ„æ€§èƒ½ã€‚



ä¸‰ï¼š`flush`

ä½œç”¨ï¼šèƒ½è®©`watch`è®¿é—®æ›´æ–°åçš„`dom`

åŸå› ï¼šå½“ä½ æ›´æ”¹äº†å“åº”å¼çŠ¶æ€ï¼Œå®ƒå¯èƒ½ä¼šåŒæ—¶è§¦å‘`Vue` ç»„ä»¶æ›´æ–°å’Œä¾¦å¬å™¨å›è°ƒã€‚ä½†æ˜¯é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·åˆ›å»ºçš„ä¾¦å¬å™¨å›è°ƒï¼Œéƒ½ä¼šåœ¨ Vue ç»„ä»¶æ›´æ–°**ä¹‹å‰**è¢«è°ƒç”¨ã€‚è¿™æ„å‘³ç€ä½ åœ¨ä¾¦å¬å™¨å›è°ƒä¸­è®¿é—®çš„ DOM å°†æ˜¯è¢« Vue æ›´æ–°**ä¹‹å‰**çš„çŠ¶æ€ã€‚

å¦‚æœæƒ³åœ¨ä¾¦å¬å™¨å›è°ƒä¸­èƒ½è®¿é—®è¢« Vue æ›´æ–°**ä¹‹å**çš„ DOMï¼Œä½ éœ€è¦æŒ‡æ˜ `flush: 'post'` é€‰é¡¹ï¼š

```js
watch(source, callback, {
  flush: 'post'
})

watchEffect(callback, {
  flush: 'post'
})

// æ³¨æ„åç½®åˆ·æ–°çš„watchEffectå‡½æ•°è¿˜æœ‰ä¸ªä¸“é—¨çš„APIäº¤watchPostEffect()
import { watchPostEffect } from 'vue'

watchPostEffect(() => {
  /* åœ¨ Vue æ›´æ–°åæ‰§è¡Œ */
})
```





### åœæ­¢ä¾¦å¬å™¨watch

æ­£å¸¸ä½¿ç”¨æƒ…å†µä¸‹ï¼Œwatchæ˜¯åŒæ­¥è°ƒç”¨çš„ï¼Œä¼šè‡ªåŠ¨ç»‘å®šåœ¨ç»„ä»¶å®ä¾‹èº«ä¸Šï¼Œ**éšç€ç»„ä»¶å®ä¾‹çš„åˆ›å»ºè€Œåˆ›å»ºï¼Œé”€æ¯è€Œè‡ªåŠ¨åœæ­¢**ã€‚å› æ­¤ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ æ— éœ€å…³å¿ƒæ€ä¹ˆåœæ­¢ä¸€ä¸ªä¾¦å¬å™¨



ä¸€ä¸ªå…³é”®ç‚¹æ˜¯ï¼Œä¾¦å¬å™¨å¿…é¡»ç”¨**åŒæ­¥**è¯­å¥åˆ›å»ºï¼šå¦‚æœç”¨å¼‚æ­¥å›è°ƒåˆ›å»ºä¸€ä¸ªä¾¦å¬å™¨ï¼Œé‚£ä¹ˆå®ƒä¸ä¼šç»‘å®šåˆ°å½“å‰ç»„ä»¶ä¸Šï¼Œä½ å¿…é¡»æ‰‹åŠ¨åœæ­¢å®ƒï¼Œä»¥é˜²å†…å­˜æ³„æ¼ã€‚å¦‚ä¸‹æ–¹è¿™ä¸ªä¾‹å­ï¼š

```vue
<script setup>
import { watchEffect } from 'vue'

// å®ƒä¼šè‡ªåŠ¨åœæ­¢
watchEffect(() => {})

// ...è¿™ä¸ªåˆ™ä¸ä¼šï¼
setTimeout(() => {
  watchEffect(() => {})
}, 100)
</script>
```



å¦‚æœè¦åœæ­¢ä¸€ä¸ªä¾¦å¬å™¨ï¼Œè¯·è°ƒç”¨watchè¿”å›çš„å‡½æ•°

```js
const unwatch = watchEffect(() => {})

// ...å½“è¯¥ä¾¦å¬å™¨ä¸å†éœ€è¦æ—¶
unwatch()
```







## `watchEffect()`å‡½æ•°

`wacthEffect()`è·Ÿwatch()çš„ä½œç”¨åŸºæœ¬ä¸€æ ·ï¼Œç”¨äºç›‘å¬å“åº”æ€§æ•°æ®çš„å˜åŒ–ï¼Œå¹¶æ ¹æ®å˜åŒ–åšå‡ºä¸€äº›ç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¾‹å¦‚è¯·æ±‚è¿œç¨‹æœåŠ¡æ•°æ®ã€‚

>`watchEffect`æ˜¯ä¼šè‡ªåŠ¨ä¾¦å¬å‡½æ•°ä¸­çš„å“åº”å¼æ•°æ®ï¼Œå½“å“åº”å¼æ•°æ®æ”¹å˜æ—¶ï¼Œå°±ä¼šé‡æ–°è°ƒç”¨ä¸€éå›è°ƒ

è¯­æ³•ï¼š

```js
import {watchEffect,ref} from 'vue'
const options = ref({
  title: '1',
  name: '2'
})

watchEffect(() => {
  // ä¸€æ—¦å›è°ƒå‡½æ•°ä¸­çš„å€¼æœ‰å˜åŒ–ï¼Œè¯¥å›è°ƒå°±ä¼šé‡æ–°æ‰§è¡Œä¸€æ¬¡
  console.log(options.value.title)
  console.log(options.value.name)
})
```

æ³¨æ„ï¼š**watchEffect()å‡½æ•°åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶ä¼šè°ƒç”¨ç¬¬ä¸€æ¬¡**ï¼Œéšåæ ¹æ®å›è°ƒå‡½æ•°ä¸­çš„å€¼å†³å®šè°ƒç”¨æ¬¡æ•°

ä½¿ç”¨åœºæ™¯ï¼š

![06-watchEffect](../../å‰ç«¯å›¾ç‰‡/vue3.2/06-watchEffect.PNG)

åƒåˆ†é¡µåŠŸèƒ½ï¼Œå°±å¯ä»¥ä½¿ç”¨watchEffect()



## watchEffectå’Œwatchæ”¶å°¾å·¥ä½œ

watchEffectçš„æ”¶å°¾å·¥ä½œï¼š

```js
watchEffect((onInvalidate)=> {
  onInvalidate(() => {
    console.log('åšä¸€äº›æ”¶å°¾å·¥ä½œ...');
  })
})
```

watchçš„æ”¶å°¾å·¥ä½œï¼š

```js
watch(
	()=>options.value.title,
  (newVal, oldVal, onInvalidate) => {
			onInvalidate(() => {
        console.log('åšä¸€äº›æ”¶å°¾å·¥ä½œ...');
      })
  }
)
```

æ³¨æ„ï¼š**onInvalidate()ä¼šåœ¨ä¸‹æ¬¡ç›‘å¬ä»£ç æ‰§è¡Œåæ‰§è¡Œ**

ç®€å•æ¥è¯´ï¼šå°±æ˜¯ç¬¬ä¸€æ¬¡ç›‘å¬åˆ°æ•°æ®æ”¹å˜`onInvalidate()`ä¸ä¼šæ‰§è¡Œï¼Œç¬¬äºŒæ¬¡ç›‘å¬åˆ°æ•°æ®æ”¹å˜åæ‰§è¡Œ`onInvalidate()`





## æ¨¡æ¿å¼•ç”¨(è·å–`dom`å¼•ç”¨)

ä¸ºäº†é€šè¿‡ç»„åˆå¼` API `è·å¾—è¯¥æ¨¡æ¿å¼•ç”¨ï¼Œæˆ‘ä»¬éœ€è¦å£°æ˜ä¸€ä¸ªåŒåçš„ ref

>æ³¨æ„ï¼šå’Œref()å“åº”å¼æ•°æ®é‚£ä¸ªåŒåï¼Œä½†æ˜¯å¿…é¡»è¦ä¼ å…¥nullä¸”ä¸templateä¸­çš„refåŒå

```vue
<script setup>
import { ref, onMounted } from 'vue'

// å£°æ˜ä¸€ä¸ª ref æ¥å­˜æ”¾è¯¥å…ƒç´ çš„å¼•ç”¨
// å¿…é¡»å’Œæ¨¡æ¿é‡Œçš„ ref åŒå
const input = ref(null)

onMounted(() => {
  input.value.focus()
})
</script>

<template>
  <input ref="input" />
</template>
```



æ³¨æ„ï¼Œä½ åªå¯ä»¥**åœ¨ç»„ä»¶æŒ‚è½½å**æ‰èƒ½è®¿é—®æ¨¡æ¿å¼•ç”¨ã€‚å¦‚æœä½ æƒ³åœ¨æ¨¡æ¿ä¸­çš„è¡¨è¾¾å¼ä¸Šè®¿é—® `input`ï¼Œåœ¨åˆæ¬¡æ¸²æŸ“æ—¶ä¼šæ˜¯ `null`ã€‚è¿™æ˜¯å› ä¸ºåœ¨åˆæ¬¡æ¸²æŸ“å‰è¿™ä¸ªå…ƒç´ è¿˜ä¸å­˜åœ¨å‘¢ï¼

å¦‚æœä½ éœ€è¦ä¾¦å¬ä¸€ä¸ªæ¨¡æ¿å¼•ç”¨ ref çš„å˜åŒ–ï¼Œç¡®ä¿è€ƒè™‘åˆ°å…¶å€¼ä¸º `null` çš„æƒ…å†µï¼š

```js
watchEffect(() => {
  if (input.value) {
    input.value.focus()
  } else {
    // æ­¤æ—¶è¿˜æœªæŒ‚è½½ï¼Œæˆ–æ­¤å…ƒç´ å·²ç»è¢«å¸è½½ï¼ˆä¾‹å¦‚é€šè¿‡ v-if æ§åˆ¶ï¼‰
  }
})
```



### v-forä¸­çš„æ¨¡æ¿å¼•ç”¨

>éœ€è¦ v3.2.25 åŠä»¥ä¸Šç‰ˆæœ¬

å½“åœ¨ `v-for` ä¸­ä½¿ç”¨æ¨¡æ¿å¼•ç”¨æ—¶ï¼Œå¯¹åº”çš„ ref ä¸­åŒ…å«çš„å€¼æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå®ƒå°†åœ¨å…ƒç´ è¢«æŒ‚è½½ååŒ…å«å¯¹åº”æ•´ä¸ªåˆ—è¡¨çš„æ‰€æœ‰å…ƒç´ ï¼š

```vue
const list = ref([
  /* ... */
])

const itemRefs = ref([])

onMounted(() => console.log(itemRefs.value))
</script>

<template>
  <ul>
    <li v-for="item in list" ref="itemRefs">
      {{ item }}
    </li>
  </ul>
</template>
```



### ç»„ä»¶çš„ref

æ¨¡æ¿å¼•ç”¨ä¹Ÿå¯ä»¥è¢«ç”¨åœ¨ä¸€ä¸ªå­ç»„ä»¶ä¸Šã€‚è¿™ç§æƒ…å†µä¸‹å¼•ç”¨ä¸­è·å¾—çš„å€¼æ˜¯ç»„ä»¶å®ä¾‹ï¼š

```vue
<script setup>
import { ref, onMounted } from 'vue'
import Child from './Child.vue'

const child = ref(null)

onMounted(() => {
  // child.value æ˜¯ <Child /> ç»„ä»¶çš„å®ä¾‹
})
</script>

<template>
  <Child ref="child" />
</template>
```

å¦‚æœä¸€ä¸ªå­ç»„ä»¶ä½¿ç”¨çš„æ˜¯é€‰é¡¹å¼` API `æˆ–æ²¡æœ‰ä½¿ç”¨ `<script setup>`ï¼Œè¢«å¼•ç”¨çš„ç»„ä»¶å®ä¾‹å’Œè¯¥å­ç»„ä»¶çš„ `this` å®Œå…¨ä¸€è‡´ï¼Œè¿™æ„å‘³ç€çˆ¶ç»„ä»¶å¯¹å­ç»„ä»¶çš„æ¯ä¸€ä¸ªå±æ€§å’Œæ–¹æ³•éƒ½æœ‰å®Œå…¨çš„è®¿é—®æƒ(**æ³¨æ„è¿™é‡Œå¿…é¡»çˆ¶å­ç»„ä»¶éƒ½è¦æ˜¯é€‰é¡¹å¼`API`æˆ–æ²¡æœ‰ä½¿ç”¨ `<script setup>`**)ã€‚è¿™ä½¿å¾—åœ¨çˆ¶ç»„ä»¶å’Œå­ç»„ä»¶ä¹‹é—´åˆ›å»ºç´§å¯†è€¦åˆçš„å®ç°ç»†èŠ‚å˜å¾—å¾ˆå®¹æ˜“ï¼Œå½“ç„¶ä¹Ÿå› æ­¤ï¼Œåº”è¯¥åªåœ¨ç»å¯¹éœ€è¦æ—¶æ‰ä½¿ç”¨ç»„ä»¶å¼•ç”¨ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ**ä½ åº”è¯¥é¦–å…ˆä½¿ç”¨æ ‡å‡†çš„ props å’Œ emit æ¥å£æ¥å®ç°çˆ¶å­ç»„ä»¶äº¤äº’**ã€‚



å¦‚æœä½¿ç”¨äº† `<script setup>`ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`defineExpose`æ–¹æ³•æ¥æš´éœ²æŒ‡å®šå†…å®¹ç»™çˆ¶ç»„ä»¶

ç¤ºä¾‹ï¼š

```vue
<script setup>
import { ref } from 'vue'

const a = 1
const b = ref(2)
const add = () => {
  a += 1;
}
// åƒ defineExpose è¿™æ ·çš„ç¼–è¯‘å™¨å®ä¸éœ€è¦å¯¼å…¥
defineExpose({
  a,
  b,
  add // æš´éœ²ä¸€ä¸ªæ–¹æ³•
})
</script>
```







# å…¶ä»–æ³¨æ„ç‚¹

## å°†æ™®é€špropsæ•°æ®è½¬æ¢ä¸ºå“åº”å¼çš„(toRefs)

æˆ‘çš„å»ºè®®æ˜¯ï¼šä¼ é€’çš„propså¦‚æœä½¿ç”¨è§£æ„èµ‹å€¼è¯­æ³•ä»propsä¸­å–å€¼ï¼Œéƒ½è¦ç”¨`toRefs()`åŒ…è£¹ä¸€ä¸‹`props`

ç¤ºä¾‹ï¼š

```js
const {xx} = toRefs(props)
```





å¦‚æœï¼šåœ¨setupå‡½æ•°æ¥æ”¶çš„`props`å¯¹è±¡ï¼Œæ•´ä½“æ˜¯ä¸€ä¸ªå“åº”å¼çš„å¯¹è±¡ã€‚æƒ³è¦ç›‘å¬æ—¶éœ€è¦é€šè¿‡`props.value.xxx`æ¥ç›‘å¬ï¼Œå¦‚æœä½¿ç”¨äº†**è§£æ„èµ‹å€¼è¯­æ³•**é‚£ä¹ˆå°±ä¼šä¸¢å¤±å“åº”æ€§ï¼Œéœ€è¦`toRefs`æ¥åŒ…è£…ã€‚

æ³¨æ„ï¼š**å¦‚æœä½¿ç”¨ç»“æ„èµ‹å€¼è¯­æ³•ï¼Œè¦ä½¿ç”¨`toRefs`**

è§£å†³åŠæ³•ï¼šä½¿ç”¨`toRefs()`å‡½æ•°

ç¤ºä¾‹ï¼š

```vue
<--!çˆ¶ç»„ä»¶-->
<Item title='æ ‡é¢˜' />

  // å­ç»„ä»¶
<script>
	import { toRefs } from 'vue';
  props:['title']
  setup(props) {
    // è¿™ä¹Ÿpropså°±ä¼šå˜ä¸ºå“åº”å¼çš„äº†
    const {titlel} = toRefs(props);
  }
</script>
```



å¦‚æœï¼šçˆ¶ç»„ä»¶åœ¨ä¼ é€’æ•°æ®æ—¶ï¼Œ**ä¼ é€’çš„æ˜¯å“åº”æ€§æ•°æ®**(ç”¨refæˆ–reactiveä¿®é¥°è¿‡çš„)é‚£ä¹ˆä¼ é€’åˆ°**å­ç»„ä»¶ä¸­çš„propsä¹Ÿæ˜¯å“åº”æ€§æ•°æ®ã€‚**

æ³¨æ„ï¼šä½¿ç”¨è§£æ„èµ‹å€¼ä»»ç„¶æœ‰å“åº”æ€§çš„ï¼ˆåªæœ‰å¯¹è±¡å’Œæ•°ç»„ç±»å‹çš„å¯ä»¥ï¼ŒåŸºæœ¬ç±»å‹è¿˜æ˜¯è¦ç”¨toRefsåŒ…è£¹ä¸€ä¸‹ï¼‰



## è‡ªå®šä¹‰äº‹ä»¶(emit)

ç”±äºsetupå‡½æ•°ä¸­æ²¡æœ‰thisï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡thisè®¿é—®æ¥æ”¶åˆ°çš„`emits:['customEvent']`ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡setup()ç¬¬äºŒä¸ªå‚æ•°è®¿é—®åˆ°ã€‚

ç¤ºä¾‹ï¼š

```vue
<template>
	<div @click="$emit('customEvent')">
    æ¨¡æ¿ä¸­ä½¿ç”¨çš„æ–¹å¼æ²¡æœ‰æ”¹å˜
  </div>
</template>

<script>
	emits:['customEvent'],
  setup(props, context) {
    // è°ƒç”¨é€šè¿‡context.emitæ¥è§¦å‘
    context.emit('customEvent');
  }
</script>
```



## ç”Ÿå‘½å‘¨æœŸé’©å­

å’Œvue2ä¸­çš„åŒºåˆ«ï¼Œç”Ÿå‘½å‘¨æœŸå‰é¢éƒ½åŠ ä¸Šäº†`on`ã€‚å¹¶ä¸”éƒ½å˜æˆäº†è¦ç»™å‡½æ•°ã€‚

![07-vue3.2ç”Ÿå‘½å‘¨æœŸ](../../å‰ç«¯å›¾ç‰‡/vue3.2/07-vue3.2ç”Ÿå‘½å‘¨æœŸ.PNG)

![07-vue3.2ç”Ÿå‘½å‘¨æœŸ2](../../å‰ç«¯å›¾ç‰‡/vue3.2/07-vue3.2ç”Ÿå‘½å‘¨æœŸ2.PNG)

æ³¨æ„ï¼šç”±äº`setup`å‡½æ•°æ‰§è¡Œçš„å‘¨æœŸå°±æ˜¯åœ¨`beforeCreate`å’Œ`created`ä¹‹é—´ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸçš„é€»è¾‘ç›´æ¥å†™åœ¨`setup`å‡½æ•°ä¸­å°±è¡Œã€‚



ä¾‹å¦‚ï¼š

```js
// mountedå˜ä¸º
onMounted(() => {
  // ä¸šåŠ¡ä»£ç 
})
```



## provideå’Œinjectçš„æ›¿ä»£

provideå’Œinjecté…ç½®é¡¹ï¼Œåœ¨vue2ä¸­æ˜¯ç”¨æ¥ç»™åµŒå¥—å¤šçº§çš„ç»„ä»¶ä¼ é€’æ•°æ®çš„ã€‚åœ¨vue3ä¸­ï¼Œè¿™ä¿©å˜æˆäº†ä¸¤ä¸ªå‡½æ•°ã€‚

ç¤ºä¾‹ï¼š**ä¼ é€’éå“åº”å¼æ•°æ®ã€‚**

```vue
<template>
	<!--æœ€å¤–å±‚ç»„ä»¶-->
	<Item />
</template>
<script>
	import { provide } from 'vue';
  setup() {
    const movie = {
      title: 'ç”µå½±'
    }
    // provideä¼ é€’ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªä¸ºå‚æ•°åï¼Œç¬¬äºŒä¸ªä¸ºå®é™…ä¼ é€’çš„å‚æ•°ã€‚
    provide(title, movie.title)
  }
</script>


<script>
  // æœ€å†…å±‚ç»„ä»¶
	import { inject } from 'vue';
  setup() {
    // æ¥æ”¶åˆ°provideä¼ é€’çš„title
    const title = inject('title');
    return {title};
  }
</script>
```



å¦‚æœæƒ³è¦ä¼ é€’å“åº”æ€§æ•°æ®ï¼šè¿˜æ˜¯æœ‰å“åº”å¼æ•°æ®çš„é€šç—…ï¼Œå»ºè®®ä½¿ç”¨toRefæˆ–è€…toRefså¤„ç†ä¸€ä¸‹

ç¤ºä¾‹ï¼š

```vue
<template>
	<!--æœ€å¤–å±‚ç»„ä»¶-->
	<Item />
</template>
<script>
	import { provide,refï¼ŒtoRef } from 'vue';
  setup() {
    const movie = ref({
      title: 'ç”µå½±'
    })
    // 1.ä¼ é€’æ•´ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆå¯ä»¥æ˜¯å“åº”æ€§çš„
    // provide(movie, movie.value)
    
    // 2.å¦‚æœä¼ é€’å¯¹è±¡ä¸­çš„ä¸€ä¸ªå€¼,è¿™ä¹Ÿå°±ä¼šä¸¢å¤±å“åº”æ€§(å“åº”å¼æ•°æ®ä¼ é€’çš„é€šç—…)éœ€è¦ä½¿ç”¨toRef
    // provide(title, movie.value.title);
    
    // 3.ä¸Šé¢ç¬¬äºŒæ¡çš„æ”¹è¿›ç‰ˆ,ä½¿ç”¨toRefåŒ…è£…ä¸€ä¸‹
    provide(title, toRef(movie.value, movie.value.title));
  }
</script>


<script>
  // æœ€å†…å±‚ç»„ä»¶
	import { inject } from 'vue';
  setup() {
    // æ¥æ”¶åˆ°provideä¼ é€’çš„title
    const title = inject('title');
    return {title};
  }
</script>
```



## contextçš„soltså±æ€§

è¯¥å±æ€§å’Œæ¸²æŸ“å‡½æ•°æœ‰å…³ï¼Œå¯ä»¥å»å®˜ç½‘çœ‹ä¸€çœ‹ã€‚

## contextçš„attrså±æ€§

contextæ˜¯setupå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚

attrså±æ€§ç”¨äºæ›¿æ¢vue2ä¸­çš„this.$attrsï¼ŒåŠŸèƒ½ä¸€è‡´éƒ½æ˜¯ä¸ºäº†è®¿é—®ï¼Œä¼ é€’ä½†æ²¡æœ‰æ¥æ”¶çš„`props`

ç¤ºä¾‹ï¼š

```vue
<template>
	<!--çˆ¶ç»„ä»¶-->
	<AutoFocus name="é’±ä¸äºŒ"></AutoFocus>
</template>



// å­ç»„ä»¶
<template>
	<input type="text" ref="inputControl" />
</template>
<script>
import { onMounted, ref } from 'vue';
export default {
	setup(props, { attrs }) {
    // é€šè¿‡attrsæ¥è®¿é—®name
		console.log(attrs);
	}
};
</script>

```

æ³¨æ„ï¼šattrså¯¹è±¡æœ¬èº«æ˜¯ç›¸åº”æ€§çš„ï¼Œä½†æ˜¯å®ƒé‡Œé¢çš„æ•°æ®ä¸æ˜¯ã€‚å®ƒä¹Ÿæœ‰å“åº”å¼æ•°æ®çš„é€šç—…ï¼Œæƒ³è¦æœ‰å“åº”å¼éœ€è¦`toRefs`æˆ–`toRef`







## è‡ªå®šä¹‰ç»„ä»¶çš„v-model(`vue3.2`)

æˆ‘ä»¬å¯ä»¥å…ˆçœ‹ä¸€ä¸‹`vue2`çš„ï¼Œé»˜è®¤è‡ªå®šä¹‰ç»„ä»¶ç»‘å®šv-modelåçš„æ ·å­ï¼š

```vue
<CustomInput v-model="searchText" />
<!-- é»˜è®¤ä¼šå˜æˆä¸‹é¢çš„æ ·å­ -->
<CustomInput :value="searchText"  @input="(val) => {searchText = val}"/>
```

å­ç»„ä»¶å¯¹åº”ä»£ç ï¼š

```vue
<template>
  <input
    :value="value"
    @input="$emit('input', $event.target.value)"
  />
</template>
<script>
	export default {
    props: {
      value: {}
    }
  }
</script>
```



---

`vue3.2`çš„è‡ªå®šä¹‰ç»„ä»¶åŒå‘ç»‘å®šï¼ŒåŸç†åŸºæœ¬ä¸€è‡´ï¼Œåå­—æ”¹å˜äº†è€Œå·²ï¼š

```vue
<CustomInput v-model="searchText" />
<!-- é»˜è®¤ä¼šå˜æˆä¸‹é¢çš„æ ·å­ -->
<CustomInput
  :modelValue="searchText"
  @update:modelValue="newValue => searchText = newValue"
/>
```

å­ç»„ä»¶å¯¹åº”ä»£ç ï¼š

```vue
<!-- CustomInput.vue -->
<script setup>
defineProps(['modelValue'])
defineEmits(['update:modelValue'])
</script>

<template>
  <input
    :value="modelValue"
    @input="$emit('update:modelValue', $event.target.value)"
  />
</template>
```



**åˆ©ç”¨è®¡ç®—å±æ€§æ¥ç®€åŒ–ä¸Šé¢çš„å†…å®¹:**

```vue
<!-- CustomInput.vue -->
<script setup>
import { computed } from 'vue'
const props = defineProps(['modelValue'])
const emit = defineEmits(['update:modelValue'])
const value = computed({
  get() {
    return props.modelValue;
  },
  set(newValue) {
    return emit('update:modelValue', newValue)
  }
})
</script>

<template>
  <input
   	v-model="value"
  />
</template>
```





**v-modelçš„å‚æ•°**ï¼š

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`v-model` åœ¨ç»„ä»¶ä¸Šéƒ½æ˜¯ä½¿ç”¨ `modelValue` ä½œä¸º propï¼Œå¹¶ä»¥ `update:modelValue` ä½œä¸ºå¯¹åº”çš„äº‹ä»¶ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™ `v-model` æŒ‡å®šä¸€ä¸ªå‚æ•°æ¥æ›´æ”¹è¿™äº›åå­—ï¼š

```vue
<MyComponent v-model:title="bookTitle" />

<!-- MyComponent.vue -->
<script setup>
defineProps(['title'])
defineEmits(['update:title'])
</script>

<template>
  <input
    type="text"
    :value="title"
    @input="$emit('update:title', $event.target.value)"
  />
</template>
```





**è‡ªå®šä¹‰ç»„ä»¶çš„å¤šä¸ªv-modelç»‘å®š**ï¼š

åˆ©ç”¨ä¸Šé¢çš„`v-model`å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è‡ªå®šä¹‰ç»„ä»¶èº«ä¸Šåˆ›å»ºå¤šä¸ª`v-model`

ç¤ºä¾‹ï¼š

```vue
<UserName
  v-model:first-name="first"
  v-model:last-name="last"
/>

<!-- UserNameç»„ä»¶å†…å®¹ -->
<script setup>
defineProps({
  firstName: String,
  lastName: String
})

defineEmits(['update:firstName', 'update:lastName'])
</script>

<template>
  <input
    type="text"
    :value="firstName"
    @input="$emit('update:firstName', $event.target.value)"
  />
  <input
    type="text"
    :value="lastName"
    @input="$emit('update:lastName', $event.target.value)"
  />
</template>
```





### è‡ªå®šä¹‰ç»„ä»¶v-modelçš„ä¿®é¥°ç¬¦

åœ¨å­¦ä¹ è¾“å…¥ç»‘å®šæ—¶ï¼Œæˆ‘ä»¬çŸ¥é“äº† `v-model` æœ‰ä¸€äº›[å†…ç½®çš„ä¿®é¥°ç¬¦](https://cn.vuejs.org/guide/essentials/forms.html#modifiers)ï¼Œä¾‹å¦‚ `.trim`ï¼Œ`.number` å’Œ `.lazy`ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œä½ å¯èƒ½æƒ³è¦ä¸€ä¸ªè‡ªå®šä¹‰ç»„ä»¶çš„ `v-model` æ”¯æŒè‡ªå®šä¹‰çš„ä¿®é¥°ç¬¦ã€‚

ç»„ä»¶çš„ `v-model` ä¸Šæ‰€æ·»åŠ çš„ä¿®é¥°ç¬¦ï¼Œå¯ä»¥é€šè¿‡ `modelModifiers` prop åœ¨ç»„ä»¶å†…è®¿é—®åˆ°ã€‚åœ¨ä¸‹é¢çš„ç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬å£°æ˜äº† `modelModifiers` è¿™ä¸ª propï¼Œå®ƒçš„é»˜è®¤å€¼æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡



æ ¸å¿ƒï¼š`modelModifers`é…ç½®é¡¹ï¼Œå¯ä»¥æä¾›ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œæ¥æ ¹æ®æ¡ä»¶è¿›è¡Œä¸€äº›å‰¯ä½œç”¨



```vue
<Child v-model.capitalize="value" ref="child"></Child>


<!-- å­ç»„ä»¶ -->
<template>
	<div>
		<input type="text" :value="modelValue" @input="emitValue" />
	</div>
</template>

<script setup>
import {computed} from 'vue';
const props = defineProps({
	modelValue: String,
	modelModifiers: {
		default: () => {}
	}
});
const emit = defineEmits(['update:modelValue']);
console.log('ä¿®é¥°ç¬¦', props.modelModifiers); //{capitalize: true}

function emitValue(e) {
	let value = e.target.value;
	if (props.modelModifiers.capitalize) {
		value = value.charAt(0).toUpperCase() + value.slice(1);
	}
	return emit('update:modelValue', value);
}
</script>

```

