# 小程序登录流程



**第一步：获取用户信息**

通过`wx.getUserProfile()`方法来获取用户基本信息。

该方法的具体使用去官网查看：[wx.getUserProfile(Object object) | 微信开放文档 (qq.com)](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserProfile.html)



示例：

```vue
<template>
  <button @click="getUserProfile" type="primary" class="btn-login">一件登录</button>
</template>
<script>
  export default {
    name:"my-login",
    data() {
      return {
        
      };
    },
    methods: {
      // 点击登录按钮触发函数
      async getUserProfile() {
        // 调用wx.getUserProfile(), 我这里用uni-app在开发，所以是uni
        const [err, userInfo] =  await uni.getUserProfile({desc:'用户登录'});
        // 这里可以用可选链，在没有出错时，err为null会报错
        if(err?.errMsg === "getUserProfile:fail auth deny") return uni.$showMsg('您拒绝了授权');
        console.log(userInfo);
      }
    }
  }
</script>
```



**第二步：将用户信息存储到vuex中**

在user模块下（vuex的模块），写一个userInfo作为存储，在mutations中写2个方法，一个用来更新，一个用来将userinfo写入storage中做持久化。

之后在登陆时，将获取到的用户信息，调用mutations方法存储进vuex



示例：

```js
export default {
  namespaced: true,
  state: () => ({
   // 登录的token
   token: '',
   // 存储用户基本信息
   userInfo: JSON.parse(uni.getStorageSync('userInfo') || "{}")
  }),
  mutations: {
    // 更新userInfo
    updateUserInfo(state, userInfo) {
      state.userInfo = userInfo;
      this.commit('m_user/saveUserInfo');
    },
    // 将userInfo持久化
    saveUserInfo(state) {
      uni.setStorageSync('userInfo', JSON.stringify(state.userInfo))
    }
  }
}

// 登陆时，将返回的userInfo，存储进vuex
methods: {
  ...mapMutations('m_user', ['updateUserInfo']),
    async getUserProfile() {
    const  [err, userInfo] =  await uni.getUserProfile({desc:'用户登录'});
    if(err?.errMsg === "getUserProfile:fail auth deny") return uni.$showMsg('您拒绝了授权');
    // 调用mutations方法，将用户信息存储到vuex中
    this.updateUserInfo(userInfo);
    console.log(userInfo);
  }
}
```



**第三步：调用wx.login()获取接口登录凭证code**

一般后端接口登录时，都会需要一个code，和userInfo(用户基本信息)，code是通过wx.login来获取的

示例：

```js
// uni-app开发时，是uni.login
const [err, res] = await uni.login().catch(err => err);
// uni.login如果报错了，err就不是null了，直接报错
if(err ||res.errMsg !== "login:ok") return uni.$showMsg('登录失败');
```





**第四步：真正调用后端登录接口，接收返回的token并存储到vuex中**



vuex中写入2个新方法：

```js
export default {
  namespaced: true,
  state: () => ({
   // 登录的token
   // token本身就是字符串，不需要JSON.parse
   token: uni.getStorageSync('token') || "",
   // 存储用户基本信息
   userInfo: JSON.parse(uni.getStorageSync('userInfo') || "{}")
  }),
  mutations: {
    // 更新token
    updateToken(state, token) {
      state.token = token;
      this.commit('m_user/saveToken');
    },
    // 将token保存到storage中
    saveToken(state) {
      uni.setStorageSync('token', JSON.stringify(state.token));
    }
  }
}
```





登录部分：

```js
// 发起登录请求
const {data: loginResult} = await uni.$http.post('/api/public/v1/users/wxlogin', query);

if(loginResult.meta.status !== 200) return uni.$showMsg('登陆失败');

// 将token保存进vuex
this.updateToken(loginResult.token);
```

